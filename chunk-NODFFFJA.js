import{j as w,o as U}from"./chunk-W427QTGG.js";import{d as _}from"./chunk-SO6VPFYA.js";var C,D=_(()=>{"use strict";U();C=class{static ConvertPanoramaToCubemap(e,o,t,n,r=!1){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=o*t*3)throw"ConvertPanoramaToCubemap: input size is wrong";let l=this.CreateCubemapTexture(n,this.FACE_FRONT,e,o,t,r),i=this.CreateCubemapTexture(n,this.FACE_BACK,e,o,t,r),c=this.CreateCubemapTexture(n,this.FACE_LEFT,e,o,t,r),a=this.CreateCubemapTexture(n,this.FACE_RIGHT,e,o,t,r),h=this.CreateCubemapTexture(n,this.FACE_UP,e,o,t,r),f=this.CreateCubemapTexture(n,this.FACE_DOWN,e,o,t,r);return{front:l,back:i,left:c,right:a,up:h,down:f,size:n,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,o,t,n,r,l=!1){let i=new ArrayBuffer(e*e*4*3),c=new Float32Array(i),a=l?Math.max(1,Math.round(n/4/e)):1,h=1/a,f=h*h,u=o[1].subtract(o[0]).scale(h/e),b=o[3].subtract(o[2]).scale(h/e),d=1/e,F=0;for(let m=0;m<e;m++)for(let g=0;g<a;g++){let B=o[0],M=o[2];for(let R=0;R<e;R++)for(let P=0;P<a;P++){let x=M.subtract(B).scale(F).add(B);x.normalize();let E=this.CalcProjectionSpherical(x,t,n,r);c[m*e*3+R*3+0]+=E.r*f,c[m*e*3+R*3+1]+=E.g*f,c[m*e*3+R*3+2]+=E.b*f,B=B.add(u),M=M.add(b)}F+=d*h}return c}static CalcProjectionSpherical(e,o,t,n){let r=Math.atan2(e.z,e.x),l=Math.acos(e.y);for(;r<-Math.PI;)r+=2*Math.PI;for(;r>Math.PI;)r-=2*Math.PI;let i=r/Math.PI,c=l/Math.PI;i=i*.5+.5;let a=Math.round(i*t);a<0?a=0:a>=t&&(a=t-1);let h=Math.round(c*n);h<0?h=0:h>=n&&(h=n-1);let f=n-h-1,u=o[f*t*3+a*3+0],b=o[f*t*3+a*3+1],d=o[f*t*3+a*3+2];return{r:u,g:b,b:d}}};C.FACE_LEFT=[new w(-1,-1,-1),new w(1,-1,-1),new w(-1,1,-1),new w(1,1,-1)];C.FACE_RIGHT=[new w(1,-1,1),new w(-1,-1,1),new w(1,1,1),new w(-1,1,1)];C.FACE_FRONT=[new w(1,-1,-1),new w(1,-1,1),new w(1,1,-1),new w(1,1,1)];C.FACE_BACK=[new w(-1,-1,1),new w(-1,-1,-1),new w(-1,1,1),new w(-1,1,-1)];C.FACE_DOWN=[new w(1,1,-1),new w(1,1,1),new w(-1,1,-1),new w(-1,1,1)];C.FACE_UP=[new w(-1,-1,-1),new w(-1,-1,1),new w(1,-1,-1),new w(1,-1,1)]});function v(s,e){return e>1023?s*Math.pow(2,1023)*Math.pow(2,e-1023):e<-1074?s*Math.pow(2,-1074)*Math.pow(2,e+1074):s*Math.pow(2,e)}function G(s,e,o,t,n,r){n>0?(n=v(1,n-(128+8)),s[r+0]=e*n,s[r+1]=o*n,s[r+2]=t*n):(s[r+0]=0,s[r+1]=0,s[r+2]=0)}function T(s,e){let o="",t="";for(let n=e;n<s.length-e&&(t=String.fromCharCode(s[n]),t!=`
`);n++)o+=t;return o}function p(s){let e=0,o=0,t=T(s,0);if(t[0]!="#"||t[1]!="?")throw"Bad HDR Format.";let n=!1,r=!1,l=0;do l+=t.length+1,t=T(s,l),t=="FORMAT=32-bit_rle_rgbe"?r=!0:t.length==0&&(n=!0);while(!n);if(!r)throw"HDR Bad header format, unsupported FORMAT";l+=t.length+1,t=T(s,l);let c=/^-Y (.*) \+X (.*)$/g.exec(t);if(!c||c.length<3)throw"HDR Bad header format, no size";if(o=parseInt(c[2]),e=parseInt(c[1]),o<8||o>32767)throw"HDR Bad header format, unsupported size";return l+=t.length+1,{height:e,width:o,dataPosition:l}}function N(s,e,o=!1){let t=new Uint8Array(s),n=p(t),r=A(t,n);return C.ConvertPanoramaToCubemap(r,n.width,n.height,e,o)}function A(s,e){return j(s,e)}function j(s,e){let o=e.height,t=e.width,n,r,l,i,c,a=e.dataPosition,h=0,f=0,u=0,b=new ArrayBuffer(t*4),d=new Uint8Array(b),F=new ArrayBuffer(e.width*e.height*4*3),m=new Float32Array(F);for(;o>0;){if(n=s[a++],r=s[a++],l=s[a++],i=s[a++],n!=2||r!=2||l&128||e.width<8||e.width>32767)return k(s,e);if((l<<8|i)!=t)throw"HDR Bad header format, wrong scan line width";for(h=0,u=0;u<4;u++)for(f=(u+1)*t;h<f;)if(n=s[a++],r=s[a++],n>128){if(c=n-128,c==0||c>f-h)throw"HDR Bad Format, bad scanline data (run)";for(;c-- >0;)d[h++]=r}else{if(c=n,c==0||c>f-h)throw"HDR Bad Format, bad scanline data (non-run)";if(d[h++]=r,--c>0)for(let g=0;g<c;g++)d[h++]=s[a++]}for(u=0;u<t;u++)n=d[u],r=d[u+t],l=d[u+2*t],i=d[u+3*t],G(m,n,r,l,i,(e.height-o)*t*3+u*3);o--}return m}function k(s,e){let o=e.height,t=e.width,n,r,l,i,c,a=e.dataPosition,h=new ArrayBuffer(e.width*e.height*4*3),f=new Float32Array(h);for(;o>0;){for(c=0;c<e.width;c++)n=s[a++],r=s[a++],l=s[a++],i=s[a++],G(f,n,r,l,i,(e.height-o)*t*3+c*3);o--}return f}var Y,L=_(()=>{"use strict";D();Y={RGBE_ReadHeader:p,GetCubeMapTextureData:N,RGBE_ReadPixels:A}});var O,y=_(()=>{L();O=class{constructor(){this.supportCascades=!1}loadCubeData(){throw".hdr not supported in Cube."}loadData(e,o,t){let n=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=p(n),l=A(n,r),i=r.width*r.height,c=new Float32Array(i*4);for(let a=0;a<i;a+=1)c[a*4]=l[a*3],c[a*4+1]=l[a*3+1],c[a*4+2]=l[a*3+2],c[a*4+3]=1;t(r.width,r.height,o.generateMipMaps,!1,()=>{let a=o.getEngine();o.type=1,o.format=5,o._gammaSpace=!1,a._uploadDataToTextureDirectly(o,c)})}}});export{C as a,D as b,N as c,Y as d,L as e,O as f,y as g};
