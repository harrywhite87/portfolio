import{T as te,U as we}from"./chunk-YFA33DOZ.js";import{H as ee,M as xe,q as J,r as me,s as Q,t as ye,y as B,z as Z}from"./chunk-74DXLQM5.js";import{c as D,d as q}from"./chunk-MJJ6SHXP.js";import{j as z,o as de}from"./chunk-W427QTGG.js";import{b as X,f as ge}from"./chunk-2KJFAWAJ.js";import{c as K,f as he}from"./chunk-XAFYO27J.js";import{g as N,h as ce}from"./chunk-BKKMM5NX.js";import{a as $,b as ue}from"./chunk-BE7GIU5G.js";import{h as G,k as fe}from"./chunk-HKRXH733.js";import{a as j,b as Y,d as S,j as C}from"./chunk-SO6VPFYA.js";var E,re=S(()=>{"use strict";Z();xe();E=class{static ExpandRGBDTexture(t){let r=t._texture;if(!r||!t.isRGBD)return;let o=r.getEngine(),s=o.getCaps(),a=r.isReady,n=!1;s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?(n=!0,r.type=2):s.textureFloatRender&&s.textureFloatLinearFiltering&&(n=!0,r.type=1),n&&(r.isReady=!1,r._isRGBD=!1,r.invertY=!1);let l=()=>C(this,null,function*(){let w=o.isWebGPU,_=w?1:0;r.isReady=!1,w?yield import("./chunk-YN5AFRBJ.js"):yield import("./chunk-CSFZKQRG.js");let u=new B("rgbdDecode","rgbdDecode",null,null,1,null,3,o,!1,void 0,r.type,void 0,null,!1,void 0,_);u.externalTextureSamplerBinding=!0;let m=o.createRenderTargetTexture(r.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:r.samplingMode,type:r.type,format:5});u.onEffectCreatedObservable.addOnce(T=>{T.executeWhenCompiled(()=>{u.onApply=y=>{y._bindTexture("textureSampler",r),y.setFloat2("scale",1,1)},t.getScene().postProcessManager.directRender([u],m,!0),o.restoreDefaultFramebuffer(),o._releaseTexture(r),u&&u.dispose(),m._swapAndDie(r),r.isReady=!0})})});n&&(a?l():t.onLoadObservable.addOnce(l))}static EncodeTextureToRGBD(t,r,o=0){return C(this,null,function*(){return r.getEngine().isWebGPU?yield import("./chunk-QPRSHO2R.js"):yield import("./chunk-52N7EIUR.js"),ee("rgbdEncode",t,r,o,1,5)})}}});var oe=S(()=>{"use strict";ye();q();D.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(D.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=Q.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0})});function V(e){let t=new DataView(e.buffer,e.byteOffset,e.byteLength),r=0;for(let n=0;n<M.length;n++)if(t.getUint8(r++)!==M[n])return $.Error("Not a babylon environment map"),null;let o="",s=0;for(;s=t.getUint8(r++);)o+=String.fromCharCode(s);let a=JSON.parse(o);return a=U(a),a.specular&&(a.specular.specularDataPosition=r,a.specular.lodGenerationScale=a.specular.lodGenerationScale||.8),a}function U(e){if(e.version>O)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${O}".`);return e.version===2||(e=Y(j({},e),{version:2,imageType:H})),e}function _e(r){return C(this,arguments,function*(e,t={}){let o=e.getInternalTexture();if(!o)return Promise.reject("The cube texture is invalid.");let s=t.imageType??H,a=o.getEngine();if(e.textureType!==2&&e.textureType!==1&&e.textureType!==0&&e.textureType!==0&&e.textureType!==7&&e.textureType!==-1)return Promise.reject("The cube texture should allow HDR (Full Float or Half Float).");let n=1;if(!a.getCaps().textureFloatRender&&(n=2,!a.getCaps().textureHalfFloatRender))return Promise.reject("Env texture can only be created when the browser supports half float or full float rendering.");e.sphericalPolynomial;let l=e.getInternalTexture()?._sphericalPolynomialPromise,w=o.width,_=new te(a),u={};a.flushFramebuffer();let m=G(o.width);for(let i=0;i<=m;i++){let p=Math.pow(2,m-i);for(let f=0;f<6;f++){let d=yield e.readPixels(f,i,void 0,!1);if(d&&d.byteLength===d.length){let L=new Float32Array(d.byteLength*4);for(let R=0;R<d.byteLength;R++)L[R]=d[R]/255,L[R]=Math.pow(L[R],2.2);d=L}else if(d&&e.gammaSpace){let L=d;for(let R=0;R<L.length;R++)L[R]=Math.pow(L[R],2.2)}let A=a.createRawTexture(d,p,p,5,!1,!0,1,null,n);yield E.EncodeTextureToRGBD(A,_,n);let le=yield a._readTexturePixels(A,p,p),pe=yield X(p,p,le,s,void 0,!1,!0,t.imageQuality);u[i*6+f]=pe,A.dispose()}}_.dispose(),l&&(yield l);let T={version:O,width:w,imageType:s,irradiance:Te(e),specular:{mipmaps:[],lodGenerationScale:e.lodGenerationScale}},y=0;for(let i=0;i<=m;i++)for(let p=0;p<6;p++){let f=u[i*6+p].byteLength;T.specular.mipmaps.push({length:f,position:y}),y+=f}let b=JSON.stringify(T),c=new ArrayBuffer(b.length+1),x=new Uint8Array(c);for(let i=0,p=b.length;i<p;i++)x[i]=b.charCodeAt(i);x[b.length]=0;let v=M.length+y+c.byteLength,h=new ArrayBuffer(v),P=new Uint8Array(h),F=new DataView(h),g=0;for(let i=0;i<M.length;i++)F.setUint8(g++,M[i]);P.set(new Uint8Array(c),g),g+=c.byteLength;for(let i=0;i<=m;i++)for(let p=0;p<6;p++){let f=u[i*6+p];P.set(new Uint8Array(f),g),g+=f.byteLength}return h})}function Te(e){let t=e.sphericalPolynomial;return t==null?null:{x:[t.x.x,t.x.y,t.x.z],y:[t.y.x,t.y.y,t.y.z],z:[t.z.x,t.z.y,t.z.z],xx:[t.xx.x,t.xx.y,t.xx.z],yy:[t.yy.x,t.yy.y,t.yy.z],zz:[t.zz.x,t.zz.y,t.zz.z],yz:[t.yz.x,t.yz.y,t.yz.z],zx:[t.zx.x,t.zx.y,t.zx.z],xy:[t.xy.x,t.xy.y,t.xy.z]}}function ae(e,t){t=U(t);let r=t.specular,o=Math.log2(t.width);if(o=Math.round(o)+1,r.mipmaps.length!==6*o)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);let s=new Array(o);for(let a=0;a<o;a++){s[a]=new Array(6);for(let n=0;n<6;n++){let l=r.mipmaps[a*6+n];s[a][n]=new Uint8Array(e.buffer,e.byteOffset+r.specularDataPosition+l.position,l.length)}}return s}function k(e,t,r){r=U(r);let o=r.specular;if(!o)return Promise.resolve();e._lodGenerationScale=o.lodGenerationScale;let s=ae(t,r);return I(e,s,r.imageType)}function ne(e,t,r,o,s,a,n,l,w,_,u){return new Promise((m,T)=>{if(r){let y=t.createTexture(null,!0,!0,null,1,null,b=>{T(b)},e);o?.onEffectCreatedObservable.addOnce(b=>{b.executeWhenCompiled(()=>{o.externalTextureSamplerBinding=!0,o.onApply=c=>{c._bindTexture("textureSampler",y),c.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([o],_,!0,a,n),t.restoreDefaultFramebuffer(),y.dispose(),URL.revokeObjectURL(s),m())})})}else{if(t._uploadImageToTexture(u,e,a,n),l){let y=w[n];y&&t._uploadImageToTexture(y._texture,e,a,0)}m()}})}function I(o,s){return C(this,arguments,function*(e,t,r=H){if(!K.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");let a=G(e.width)+1,n=e.getEngine(),l=!1,w=!1,_=null,u=null,m=null,T=n.getCaps();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,e),T.textureLOD?n._features.supportRenderAndCopyToLodForFloatTextures?T.textureHalfFloatRender&&T.textureHalfFloatLinearFiltering?(l=!0,e.type=2):T.textureFloatRender&&T.textureFloatLinearFiltering&&(l=!0,e.type=1):l=!1:(l=!1,w=!0,m={});let y=0;if(l)n.isWebGPU?(y=1,yield import("./chunk-YN5AFRBJ.js")):yield import("./chunk-CSFZKQRG.js"),_=new B("rgbdDecode","rgbdDecode",null,null,1,null,3,n,!1,void 0,e.type,void 0,null,!1,void 0,y),e._isRGBD=!1,e.invertY=!1,u=n.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,w){let x=e._lodGenerationScale,v=e._lodGenerationOffset;for(let h=0;h<3;h++){let F=1-h/2,g=v,i=(a-1)*x+v,p=g+(i-g)*F,f=Math.round(Math.min(Math.max(p,0),i)),d=new N(n,2);d.isCube=!0,d.invertY=!0,d.generateMipMaps=!1,n.updateTextureSamplingMode(2,d);let A=new D(null);switch(A._isCube=!0,A._texture=d,m[f]=A,h){case 0:e._lodTextureLow=A;break;case 1:e._lodTextureMid=A;break;case 2:e._lodTextureHigh=A;break}}}let b=[];for(let c=0;c<t.length;c++)for(let x=0;x<6;x++){let v=t[c][x],h=new Blob([v],{type:r}),P=URL.createObjectURL(h),F;if(n._features.forceBitmapOverHTMLImageElement)F=n.createImageBitmap(h,{premultiplyAlpha:"none"}).then(g=>ne(g,n,l,_,P,x,c,w,m,u,e));else{let g=new Image;g.src=P,F=new Promise((i,p)=>{g.onload=()=>{ne(g,n,l,_,P,x,c,w,m,u,e).then(()=>i()).catch(f=>{p(f)})},g.onerror=f=>{p(f)}})}b.push(F)}if(t.length<a){let c,x=Math.pow(2,a-1-t.length),v=x*x*4;switch(e.type){case 0:{c=new Uint8Array(v);break}case 2:{c=new Uint16Array(v);break}case 1:{c=new Float32Array(v);break}}for(let h=t.length;h<a;h++)for(let P=0;P<6;P++)n._uploadArrayBufferViewToTexture(e,c,P,h)}return Promise.all(b).then(()=>{u&&(n._releaseTexture(e),u._swapAndDie(e)),_&&_.dispose(),w&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))})})}function W(e,t){t=U(t);let r=t.irradiance;if(!r)return;let o=new J;z.FromArrayToRef(r.x,0,o.x),z.FromArrayToRef(r.y,0,o.y),z.FromArrayToRef(r.z,0,o.z),z.FromArrayToRef(r.xx,0,o.xx),z.FromArrayToRef(r.yy,0,o.yy),z.FromArrayToRef(r.zz,0,o.zz),z.FromArrayToRef(r.yz,0,o.yz),z.FromArrayToRef(r.zx,0,o.zx),z.FromArrayToRef(r.xy,0,o.xy),e._sphericalPolynomial=o}function Ve(e,t,r,o,s){let a=e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),n=I(a,t).then(()=>e);return e.onRebuildCallback=l=>({proxy:n,isReady:!0,isAsync:!0}),e._source=13,e._bufferViewArrayArray=t,e._lodGenerationScale=o,e._lodGenerationOffset=s,e._sphericalPolynomial=r,I(e,t).then(()=>(e.isReady=!0,e))}var H,O,M,ke,ie=S(()=>{"use strict";he();de();fe();me();ce();q();we();Z();ue();re();oe();ge();H="image/png",O=2,M=[134,22,135,150,246,214,150,54];ke={GetEnvInfo:V,CreateEnvTextureAsync:_e,CreateImageDataArrayBufferViews:ae,UploadEnvLevelsAsync:k,UploadLevelsAsync:I,UploadEnvSpherical:W}});var se,be=S(()=>{ie();se=class{constructor(){this.supportCascades=!1}loadCubeData(t,r,o,s,a){if(Array.isArray(t))return;let n=V(t);if(n){r.width=n.width,r.height=n.width;try{W(r,n),k(r,t,n).then(()=>{r.isReady=!0,r.onLoadedObservable.notifyObservers(r),r.onLoadedObservable.clear(),s&&s()},l=>{a?.("Can not upload environment levels",l)})}catch(l){a?.("Can not upload environment file",l)}}else a&&a("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}});export{E as a,re as b,oe as c,V as d,U as e,_e as f,ae as g,k as h,I as i,W as j,Ve as k,ke as l,ie as m,se as n,be as o};
