import{n as B,o as M}from"./chunk-MJJ6SHXP.js";import{c as C,f as P}from"./chunk-XAFYO27J.js";import{g as W,h as X}from"./chunk-BKKMM5NX.js";import{d as y}from"./chunk-SO6VPFYA.js";function V(){let e={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFBC4:4,cTFBC5:5,cTFBC7:6,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFBGR565:15,cTFRGBA4444:16,cTFFXT1_RGB:17,cTFPVRTC2_4_RGB:18,cTFPVRTC2_4_RGBA:19,cTFETC2_EAC_R11:20,cTFETC2_EAC_RG11:21},a=null;onmessage=t=>{if(t.data.action==="init"){if(t.data.url)try{importScripts(t.data.url)}catch(r){postMessage({action:"error",error:r})}a||(a=BASIS({wasmBinary:t.data.wasmBinary})),a!==null&&a.then(r=>{BASIS=r,r.initializeBasis(),postMessage({action:"init"})})}else if(t.data.action==="transcode"){let r=t.data.config,o=t.data.imageData,d=new BASIS.BasisFile(o),n=l(d),f=t.data.ignoreSupportedFormats?null:s(t.data.config,n),p=!1;f===null&&(p=!0,f=n.hasAlpha?e.cTFBC3:e.cTFBC1);let m=!0;d.startTranscoding()||(m=!1);let T=[];for(let g=0;g<n.images.length&&m;g++){let h=n.images[g];if(r.loadSingleImage===void 0||r.loadSingleImage===g){let E=h.levels.length;r.loadMipmapLevels===!1&&(E=1);for(let u=0;u<E;u++){let G=h.levels[u],D=c(d,g,u,f,p);if(!D){m=!1;break}G.transcodedPixels=D,T.push(G.transcodedPixels.buffer)}}}d.close(),d.delete(),p&&(f=-1),m?postMessage({action:"transcode",success:m,id:t.data.id,fileInfo:n,format:f},T):postMessage({action:"transcode",success:m,id:t.data.id})}};function s(t,r){let o=null;return t.supportedCompressionFormats&&(t.supportedCompressionFormats.astc?o=e.cTFASTC_4x4:t.supportedCompressionFormats.bc7?o=e.cTFBC7:t.supportedCompressionFormats.s3tc?o=r.hasAlpha?e.cTFBC3:e.cTFBC1:t.supportedCompressionFormats.pvrtc?o=r.hasAlpha?e.cTFPVRTC1_4_RGBA:e.cTFPVRTC1_4_RGB:t.supportedCompressionFormats.etc2?o=e.cTFETC2:t.supportedCompressionFormats.etc1?o=e.cTFETC1:o=e.cTFRGB565),o}function l(t){let r=t.getHasAlpha(),o=t.getNumImages(),d=[];for(let f=0;f<o;f++){let p={levels:[]},m=t.getNumLevels(f);for(let T=0;T<m;T++){let g={width:t.getImageWidth(f,T),height:t.getImageHeight(f,T)};p.levels.push(g)}d.push(p)}return{hasAlpha:r,images:d}}function c(t,r,o,d,n){let f=t.getImageTranscodedSizeInBytes(r,o,d),p=new Uint8Array(f);if(!t.transcodeImage(p,r,o,d,1,0))return null;if(n){let m=t.getImageWidth(r,o)+3&-4,T=t.getImageHeight(r,o)+3&-4;p=i(p,0,m,T)}return p}function i(t,r,o,d){let n=new Uint16Array(4),f=new Uint16Array(o*d),p=o/4,m=d/4;for(let T=0;T<m;T++)for(let g=0;g<p;g++){let h=r+8*(T*p+g);n[0]=t[h]|t[h+1]<<8,n[1]=t[h+2]|t[h+3]<<8,n[2]=(2*(n[0]&31)+1*(n[1]&31))/3|(2*(n[0]&2016)+1*(n[1]&2016))/3&2016|(2*(n[0]&63488)+1*(n[1]&63488))/3&63488,n[3]=(2*(n[1]&31)+1*(n[0]&31))/3|(2*(n[1]&2016)+1*(n[0]&2016))/3&2016|(2*(n[1]&63488)+1*(n[0]&63488))/3&63488;for(let E=0;E<4;E++){let u=t[h+4+E],G=(T*4+E)*o+g*4;f[G++]=n[u&3],f[G++]=n[u>>2&3],f[G++]=n[u>>4&3],f[G++]=n[u>>6&3]}}return f}}function k(e,a,s){return new Promise((l,c)=>{let i=t=>{t.data.action==="init"?(e.removeEventListener("message",i),l(e)):t.data.action==="error"&&c(t.data.error||"error initializing worker")};e.addEventListener("message",i),e.postMessage({action:"init",url:s?C.GetBabylonScriptURL(s):void 0,wasmBinary:a},[a])})}var x=y(()=>{"use strict";P()});var H,J,F,b,Y,U,_,$,j,q,ee,R,L,w,v,N=y(()=>{"use strict";P();M();X();x();H=class{},J=class{},F=function(e){return e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444",e[e.cTFFXT1_RGB=17]="cTFFXT1_RGB",e[e.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",e[e.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",e[e.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",e[e.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11",e}(F||{}),b={JSModuleURL:`${C._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${C._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`},Y=(e,a)=>{let s;switch(e){case F.cTFETC1:s=36196;break;case F.cTFBC1:s=33776;break;case F.cTFBC4:s=33779;break;case F.cTFASTC_4x4:s=37808;break;case F.cTFETC2:s=37496;break;case F.cTFBC7:s=36492;break}if(s===void 0)throw"The chosen Basis transcoder format is not currently supported";return s},U=null,_=null,$=0,j=!1,q=()=>(U||(U=new Promise((e,a)=>{_?e(_):C.LoadFileAsync(C.GetBabylonScriptURL(b.WasmModuleURL)).then(s=>{if(typeof URL!="function")return a("Basis transcoder requires an environment with a URL constructor");let l=URL.createObjectURL(new Blob([`(${V})()`],{type:"application/javascript"}));_=new Worker(l),k(_,s,b.JSModuleURL).then(e,a)}).catch(a)})),U),ee=e=>{_=e},R=(e,a)=>{let s=e instanceof ArrayBuffer?new Uint8Array(e):e;return new Promise((l,c)=>{q().then(()=>{let i=$++,t=o=>{o.data.action==="transcode"&&o.data.id===i&&(_.removeEventListener("message",t),o.data.success?l(o.data):c("Transcode is not supported on this device"))};_.addEventListener("message",t);let r=new Uint8Array(s.byteLength);r.set(new Uint8Array(s.buffer,s.byteOffset,s.byteLength)),_.postMessage({action:"transcode",id:i,imageData:r,config:a,ignoreSupportedFormats:j},[r.buffer])},i=>{c(i)})})},L=(e,a)=>{let s=a._gl?.TEXTURE_2D;e.isCube&&(s=a._gl?.TEXTURE_CUBE_MAP),a._bindTextureDirectly(s,e,!0)},w=(e,a)=>{let s=e.getEngine();for(let l=0;l<a.fileInfo.images.length;l++){let c=a.fileInfo.images[l].levels[0];if(e._invertVScale=e.invertY,a.format===-1||a.format===F.cTFRGB565)if(e.type=10,e.format=4,s._features.basisNeedsPOT&&(Math.log2(c.width)%1!==0||Math.log2(c.height)%1!==0)){let i=new W(s,2);e._invertVScale=e.invertY,i.type=10,i.format=4,i.width=c.width+3&-4,i.height=c.height+3&-4,L(i,s),s._uploadDataToTextureDirectly(i,new Uint16Array(c.transcodedPixels.buffer),l,0,4,!0),s._rescaleTexture(i,e,s.scenes[0],s._getInternalFormat(4),()=>{s._releaseTexture(i),L(e,s)})}else e._invertVScale=!e.invertY,e.width=c.width+3&-4,e.height=c.height+3&-4,e.samplingMode=2,L(e,s),s._uploadDataToTextureDirectly(e,new Uint16Array(c.transcodedPixels.buffer),l,0,4,!0);else{e.width=c.width,e.height=c.height,e.generateMipMaps=a.fileInfo.images[l].levels.length>1;let i=v.GetInternalFormatFromBasisFormat(a.format,s);e.format=i,L(e,s),a.fileInfo.images[l].levels.forEach((t,r)=>{s._uploadCompressedDataToTextureDirectly(e,i,t.width,t.height,t.transcodedPixels,l,r)}),s._features.basisNeedsPOT&&(Math.log2(e.width)%1!==0||Math.log2(e.height)%1!==0)&&(C.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),e._cachedWrapU=B.CLAMP_ADDRESSMODE,e._cachedWrapV=B.CLAMP_ADDRESSMODE)}}},v={JSModuleURL:b.JSModuleURL,WasmModuleURL:b.WasmModuleURL,GetInternalFormatFromBasisFormat:Y,TranscodeAsync:R,LoadTextureFromTranscodeResult:w};Object.defineProperty(v,"JSModuleURL",{get:function(){return b.JSModuleURL},set:function(e){b.JSModuleURL=e}});Object.defineProperty(v,"WasmModuleURL",{get:function(){return b.WasmModuleURL},set:function(e){b.WasmModuleURL=e}})});var z,K=y(()=>{N();P();z=class{constructor(){this.supportCascades=!1}loadCubeData(a,s,l,c,i){if(Array.isArray(a))return;let t=s.getEngine().getCaps(),r={supportedCompressionFormats:{etc1:!!t.etc1,s3tc:!!t.s3tc,pvrtc:!!t.pvrtc,etc2:!!t.etc2,astc:!!t.astc,bc7:!!t.bptc}};R(a,r).then(o=>{let d=o.fileInfo.images[0].levels.length>1&&s.generateMipMaps;w(s,o),s.getEngine()._setCubeMapTextureParams(s,d),s.isReady=!0,s.onLoadedObservable.notifyObservers(s),s.onLoadedObservable.clear(),c&&c()}).catch(o=>{let d="Failed to transcode Basis file, transcoding may not be supported on this device";C.Warn(d),s.isReady=!0,i&&i(o)})}loadData(a,s,l){let c=s.getEngine().getCaps(),i={supportedCompressionFormats:{etc1:!!c.etc1,s3tc:!!c.s3tc,pvrtc:!!c.pvrtc,etc2:!!c.etc2,astc:!!c.astc,bc7:!!c.bptc}};R(a,i).then(t=>{let r=t.fileInfo.images[0].levels[0],o=t.fileInfo.images[0].levels.length>1&&s.generateMipMaps;l(r.width,r.height,o,t.format!==-1,()=>{w(s,t)})}).catch(t=>{C.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),C.Warn(`Failed to transcode Basis file: ${t}`),l(0,0,!1,!1,()=>{},!0)})}}});export{H as a,J as b,b as c,Y as d,ee as e,R as f,w as g,v as h,N as i,z as j,K as k};
